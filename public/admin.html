<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akko Academy - Painel ADM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@400;600;800&family=Permanent+Marker&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // =========================================================================
        // ⚙️ CONFIGURAÇÃO
        // =========================================================================
        const ADMIN_EMAIL_PERMITIDO = "admin@akko.com"; 
        
        // Garanta que este ID é o mesmo usado no index.js (Backend)
        const REAL_APP_ID = '1:56272587692:web:6e62374b91269073784809';

        const manualConfig = {
          apiKey: "AIzaSyAr13YDQhGCvsbuWp3RpPH0jzpm5_MyHww",
          authDomain: "akko-academy.firebaseapp.com",
          projectId: "akko-academy",
          storageBucket: "akko-academy.firebasestorage.app",
          messagingSenderId: "56272587692",
          appId: REAL_APP_ID
        };

        const firebaseConfig = manualConfig.apiKey 
            ? manualConfig 
            : (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : JSON.parse(new URLSearchParams(window.location.search).get('firebase_config') || '{}'));

        // Usa o ID fixo para garantir consistência com as Regras de Segurança
        const appId = REAL_APP_ID;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const functions = getFunctions(app);

        // --- SISTEMA DE ALERTAS ---
        window.showAlert = (title, msg, type = 'info') => {
            const modal = document.getElementById('custom-alert');
            const titleEl = document.getElementById('alert-title');
            const msgEl = document.getElementById('alert-msg');
            const iconEl = document.getElementById('alert-icon');
            const bgEl = document.getElementById('alert-box');

            titleEl.innerText = title;
            msgEl.innerText = msg; // innerText para segurança, ou innerHTML se precisar
            
            // Estilos
            bgEl.className = "bg-white border-4 border-doodle-dark p-6 max-w-sm w-full relative transform transition-all shadow-[8px_8px_0px_#2D2B38]";
            
            if (type === 'error') {
                titleEl.className = "font-comic text-3xl mb-2 text-red-600";
                bgEl.classList.add('-rotate-1');
                iconEl.setAttribute('data-lucide', 'alert-triangle');
                iconEl.className = "w-10 h-10 text-red-600 absolute -top-5 -left-5 bg-white border-2 border-doodle-dark rounded-full p-1 transform -rotate-12";
            } else if (type === 'success') {
                titleEl.className = "font-comic text-3xl mb-2 text-doodle-green";
                bgEl.classList.add('rotate-1');
                iconEl.setAttribute('data-lucide', 'check-circle-2');
                iconEl.className = "w-10 h-10 text-doodle-green absolute -top-5 -left-5 bg-white border-2 border-doodle-dark rounded-full p-1 transform rotate-6";
            } else {
                titleEl.className = "font-comic text-3xl mb-2 text-doodle-dark";
                iconEl.setAttribute('data-lucide', 'info');
                iconEl.className = "w-10 h-10 text-doodle-purple absolute -top-5 -left-5 bg-white border-2 border-doodle-dark rounded-full p-1 transform -rotate-3";
            }

            lucide.createIcons();
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.closeAlert = () => {
            document.getElementById('custom-alert').classList.add('hidden');
            document.getElementById('custom-alert').classList.remove('flex');
        }

        // Variáveis
        let globalLessons = [];
        let globalStudents = [];
        let editingLessonId = null;
        let currentUser = null;

        // Listener de Auth
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Verifica se é o admin correto
                if(user.email === ADMIN_EMAIL_PERMITIDO) {
                    currentUser = user;
                    localStorage.setItem('adminLoggedIn', 'true');
                    showAdminPanel();
                    initRealtimeListeners();
                } else {
                    window.showAlert("ACESSO NEGADO", "Este email não é administrador.", "error");
                    signOut(auth);
                    showLoginScreen();
                }
            } else {
                showLoginScreen();
            }
        });

        window.handleAdminLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const btn = document.getElementById('btn-login');
            
            btn.disabled = true;
            btn.innerText = "ENTRANDO...";

            try {
                await signInWithEmailAndPassword(auth, email, pass);
                // O onAuthStateChanged vai lidar com o resto
            } catch (error) {
                console.error("Erro Login:", error);
                window.showAlert("ERRO DE ACESSO", "Email ou senha incorretos.", 'error');
                btn.disabled = false;
                btn.innerText = "ENTRAR NO PAINEL";
            }
        };

        window.handleLogout = () => {
            localStorage.removeItem('adminLoggedIn');
            signOut(auth);
            window.location.reload();
        };

        function showLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
        }

        function showAdminPanel() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            document.getElementById('admin-email-display').innerText = currentUser.email;
        }

        // --- DADOS EM TEMPO REAL ---
        function initRealtimeListeners() {
            // Aulas
            const qLessons = query(collection(db, 'artifacts', appId, 'public', 'data', 'lessons'));
            onSnapshot(qLessons, (snapshot) => {
                globalLessons = [];
                snapshot.forEach(doc => globalLessons.push({id: doc.id, ...doc.data()}));
                // Ordena por data
                globalLessons.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                
                updateDashboardStats();
                renderLessonsTable();
                updateModuleDatalist();
            }, (error) => {
                console.error("Erro ao ler aulas:", error);
                if(error.code === 'permission-denied') {
                    window.showAlert("ERRO DE PERMISSÃO", "Você não tem permissão para ler as aulas. Verifique as Regras do Firestore.", "error");
                }
            });

            // Alunos
            const qStudents = query(collection(db, 'artifacts', appId, 'public', 'data', 'students'));
            onSnapshot(qStudents, (snapshot) => {
                globalStudents = [];
                snapshot.forEach(doc => globalStudents.push({id: doc.id, ...doc.data()}));
                updateDashboardStats();
                renderStudentsTable();
            }, (error) => {
                console.error("Erro ao ler alunos:", error);
            });
        }

        function updateDashboardStats() {
            document.getElementById('count-lessons').innerText = globalLessons.length;
            document.getElementById('count-students').innerText = globalStudents.length;
            const uniqueModules = new Set(globalLessons.map(l => l.moduleName));
            document.getElementById('count-modules').innerText = uniqueModules.size;
        }

        function updateModuleDatalist() {
            const datalist = document.getElementById('existing-modules');
            datalist.innerHTML = '';
            new Set(globalLessons.map(l => l.moduleName)).forEach(mod => {
                const opt = document.createElement('option');
                opt.value = mod;
                datalist.appendChild(opt);
            });
        }

        // --- RENDERIZAÇÃO ---
        window.renderLessonsTable = (filter = "") => {
            const container = document.getElementById('lessons-table-body');
            container.innerHTML = '';
            const filtered = globalLessons.filter(l => l.title.toLowerCase().includes(filter.toLowerCase()));

            if(filtered.length === 0) {
                container.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-400 font-marker">Nada encontrado.</td></tr>`; return;
            }

            filtered.forEach(lesson => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-200 hover:bg-gray-50";
                const attachIcon = lesson.attachmentUrl ? `<a href="${lesson.attachmentUrl}" target="_blank" class="text-blue-500 hover:scale-110 inline-block"><i data-lucide="paperclip" class="w-4 h-4"></i></a>` : `<span class="text-gray-300">-</span>`;
                tr.innerHTML = `
                    <td class="p-3 font-comic text-doodle-purple">${lesson.moduleName}</td>
                    <td class="p-3 font-bold text-gray-700">${lesson.title}</td>
                    <td class="p-3 text-xs font-mono text-gray-500">${lesson.professor}</td>
                    <td class="p-3 text-center">${attachIcon}</td>
                    <td class="p-3 flex gap-2 justify-end">
                        <button onclick="openEditLesson('${lesson.id}')" class="p-1 text-blue-500 hover:bg-blue-100 rounded"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button onclick="deleteDocById('lessons', '${lesson.id}')" class="p-1 text-red-500 hover:bg-red-100 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                `;
                container.appendChild(tr);
            });
            lucide.createIcons();
        }

        window.renderStudentsTable = (filter = "") => {
            const container = document.getElementById('students-table-body');
            container.innerHTML = '';
            const filtered = globalStudents.filter(s => (s.name || "").toLowerCase().includes(filter.toLowerCase()) || (s.email || "").toLowerCase().includes(filter.toLowerCase()));

            if(filtered.length === 0) {
                container.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-400 font-marker">Nada encontrado.</td></tr>`; return;
            }

            filtered.forEach(student => {
                const date = student.createdAt ? new Date(student.createdAt.seconds * 1000).toLocaleDateString('pt-BR') : '-';
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-200 hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="p-3 flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-doodle-yellow border border-black flex items-center justify-center font-bold text-xs">${(student.name || '?').charAt(0).toUpperCase()}</div>
                        <span class="font-bold text-gray-700">${student.name || 'Sem Nome'}</span>
                    </td>
                    <td class="p-3 text-sm text-gray-600">${student.email}</td>
                    <td class="p-3 text-xs font-mono text-gray-400">${date}</td>
                    <td class="p-3 text-right">
                        <button onclick="deleteDocById('students', '${student.uid || student.id}')" class="p-1 text-red-500 hover:bg-red-100 rounded" title="Deletar Login e Dados"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                `;
                container.appendChild(tr);
            });
            lucide.createIcons();
        }

        // --- SYNC AUTH (Chama Backend) ---
        window.syncUsers = async () => {
            const btn = document.getElementById('btn-sync');
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-4 h-4 mr-2"></i> PROCESSANDO...`;
            lucide.createIcons();

            try {
                const syncFunc = httpsCallable(functions, 'syncAuthToFirestore');
                const result = await syncFunc({ appId: appId });
                window.showAlert("SUCESSO", `${result.data.message}`, 'success');
                setTimeout(() => window.location.reload(), 1500);
            } catch (error) {
                console.error(error);
                window.showAlert("ERRO SYNC", "Falha ao sincronizar. " + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i> SINCRONIZAR AUTH`;
                lucide.createIcons();
            }
        }

        // --- SALVAR AULA (Cria/Edita no Firestore) ---
        window.handleSaveLesson = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save-lesson');
            btn.innerText = "SALVANDO...";
            btn.disabled = true;
            
            try {
                const title = document.getElementById('inp-title').value;
                const moduleName = document.getElementById('inp-module').value;
                const professor = document.getElementById('inp-prof').value;
                const description = document.getElementById('inp-desc').value;
                let videoUrl = document.getElementById('inp-url').value;
                const fileInput = document.getElementById('inp-file');
                const attachInput = document.getElementById('inp-attachment');

                // Upload de Vídeo (se houver arquivo)
                if (fileInput.files.length > 0) {
                    btn.innerText = "ENVIANDO VÍDEO...";
                    const videoRef = ref(storage, `artifacts/${appId}/public/videos/${Date.now()}_${fileInput.files[0].name}`);
                    const snap = await uploadBytes(videoRef, fileInput.files[0]);
                    videoUrl = await getDownloadURL(snap.ref);
                }

                // Upload de Anexo (se houver arquivo)
                let attachmentUrl = null;
                if (attachInput.files.length > 0) {
                    btn.innerText = "ENVIANDO ANEXO...";
                    const attachRef = ref(storage, `artifacts/${appId}/public/attachments/${Date.now()}_${attachInput.files[0].name}`);
                    const snapAtt = await uploadBytes(attachRef, attachInput.files[0]);
                    attachmentUrl = await getDownloadURL(snapAtt.ref);
                }

                if (!videoUrl && !editingLessonId) throw new Error("O campo de vídeo (Link ou Arquivo) é obrigatório.");

                const data = { 
                    title, 
                    moduleName, 
                    professor, 
                    videoUrl, 
                    description 
                };
                
                // Só atualiza anexo se tiver um novo ou se for criação
                if (attachmentUrl) data.attachmentUrl = attachmentUrl;

                if(!editingLessonId) {
                    // CRIAÇÃO
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'lessons'), data);
                    window.showAlert("SUCESSO", "Nova aula criada!", 'success');
                } else {
                    // EDIÇÃO
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'lessons', editingLessonId), data);
                    window.showAlert("SUCESSO", "Aula atualizada com sucesso!", 'success');
                }
                
                closeLessonModal();
            } catch (err) {
                console.error("Erro ao salvar:", err);
                let msg = err.message;
                if(err.code === 'permission-denied') msg = "Permissão negada! Verifique se seu email está nas Regras do Firestore.";
                window.showAlert("ERRO AO SALVAR", msg, 'error');
            } finally { 
                btn.innerText = "SALVAR DADOS"; 
                btn.disabled = false; 
            }
        }

        window.deleteDocById = async (col, id) => {
            if(confirm("Tem certeza que deseja excluir este item?")) {
                try { 
                    if (col === 'students') {
                        // Deletar aluno via Backend (apaga Auth + Banco)
                        const deleteFunc = httpsCallable(functions, 'deleteStudent');
                        await deleteFunc({ uid: id, appId: appId });
                        window.showAlert("DELETADO", "Aluno removido do sistema.", 'success');
                        // Remove da tabela visualmente
                        globalStudents = globalStudents.filter(s => (s.uid !== id && s.id !== id));
                        renderStudentsTable();
                    } else {
                        // Deletar aula via Firestore direto
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id));
                        window.showAlert("DELETADO", "Item removido com sucesso.", 'success');
                    }
                } 
                catch(e) { 
                    console.error(e);
                    let msg = e.message;
                    if(e.code === 'permission-denied') msg = "Sem permissão para deletar.";
                    window.showAlert("ERRO", msg, 'error'); 
                }
            }
        }

        // --- MODAIS E UI ---
        window.handleCreateStudent = async (e) => { e.preventDefault(); alert("Use o Lab de Testes para criar alunos."); }
        
        window.openCreateLesson = () => {
            editingLessonId = null;
            document.getElementById('lesson-modal-title').innerText = "NOVA AULA";
            document.getElementById('lesson-form').reset();
            document.getElementById('current-attachment').classList.add('hidden');
            document.getElementById('lesson-modal').classList.remove('hidden');
        }
        
        window.openEditLesson = (id) => {
            const lesson = globalLessons.find(l => l.id === id);
            if(!lesson) return;
            editingLessonId = id;
            document.getElementById('lesson-modal-title').innerText = "EDITAR AULA";
            document.getElementById('inp-module').value = lesson.moduleName;
            document.getElementById('inp-title').value = lesson.title;
            document.getElementById('inp-prof').value = lesson.professor;
            document.getElementById('inp-desc').value = lesson.description || '';
            if(lesson.videoUrl) {
                document.getElementById('inp-url').value = lesson.videoUrl;
                toggleVideoInput('url'); 
            }
            if(lesson.attachmentUrl) {
                document.getElementById('current-attachment').classList.remove('hidden');
                document.getElementById('attachment-link').href = lesson.attachmentUrl;
            } else {
                document.getElementById('current-attachment').classList.add('hidden');
            }
            document.getElementById('lesson-modal').classList.remove('hidden');
        }
        
        window.closeLessonModal = () => document.getElementById('lesson-modal').classList.add('hidden');
        window.toggleVideoInput = (type) => {
            document.getElementById('container-url').classList.toggle('hidden', type !== 'url');
            document.getElementById('container-file').classList.toggle('hidden', type !== 'file');
            document.getElementById('tab-url').className = type === 'url' ? "px-3 py-1 text-xs font-bold border-2 border-doodle-dark bg-doodle-yellow" : "px-3 py-1 text-xs font-bold border-2 border-doodle-dark bg-white";
            document.getElementById('tab-file').className = type === 'file' ? "px-3 py-1 text-xs font-bold border-2 border-doodle-dark bg-doodle-yellow" : "px-3 py-1 text-xs font-bold border-2 border-doodle-dark bg-white";
        }
        window.switchTab = (tabId) => {
            ['dashboard', 'lessons', 'students', 'tests'].forEach(id => {
                document.getElementById('view-'+id).classList.add('hidden');
                document.getElementById('nav-'+id).classList.remove('bg-doodle-pink', 'text-white', 'scale-105');
            });
            document.getElementById('view-'+tabId).classList.remove('hidden');
            document.getElementById('nav-'+tabId).classList.add('bg-doodle-pink', 'text-white', 'scale-105');
        }
        window.filterLessons = (e) => renderLessonsTable(e.target.value);
        window.filterStudents = (e) => renderStudentsTable(e.target.value);
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], comic: ['Bangers', 'cursive'], marker: ['Permanent Marker', 'cursive'] },
                    colors: { doodle: { pink: '#FF66C4', green: '#89F279', yellow: '#F2E058', purple: '#6C5DD3', paper: '#F8F9FD', dark: '#2D2B38' } },
                    boxShadow: { 'hard': '4px 4px 0px 0px #2D2B38', 'hard-sm': '2px 2px 0px 0px #2D2B38' }
                }
            }
        }
    </script>
</head>
<body class="bg-[#F3F4F6] text-[#2D2B38] font-sans h-screen flex overflow-hidden">

    <!-- CUSTOM ALERT POPUP -->
    <div id="custom-alert" class="fixed inset-0 z-[200] hidden items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity">
        <div id="alert-box" class="bg-white border-4 border-doodle-dark shadow-[8px_8px_0px_#2D2B38] p-6 max-w-sm w-full transform relative transition-all">
            <i id="alert-icon" data-lucide="info" class="w-10 h-10 text-doodle-purple absolute -top-5 -left-5 bg-white border-2 border-doodle-dark rounded-full p-1 transform -rotate-6"></i>
            <h3 id="alert-title" class="font-comic text-3xl mb-2 text-doodle-dark">TÍTULO</h3>
            <p id="alert-msg" class="font-marker text-lg text-gray-600 mb-6 leading-snug">Mensagem aqui.</p>
            <button onclick="closeAlert()" class="w-full bg-doodle-yellow font-comic text-2xl py-2 border-2 border-doodle-dark shadow-sm hover:translate-y-1 hover:shadow-none transition-all rounded-lg">ENTENDIDO</button>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-doodle-dark flex items-center justify-center">
        <div class="bg-white p-8 border-4 border-doodle-pink shadow-[10px_10px_0px_#fff] max-w-sm w-full transform rotate-1">
            <h1 class="font-comic text-4xl text-center mb-6">AREA RESTRITA</h1>
            <form onsubmit="handleAdminLogin(event)" class="space-y-4">
                <div>
                    <label class="font-bold text-sm">EMAIL ADMIN</label>
                    <input type="email" id="login-email" class="w-full border-2 border-doodle-dark p-2" placeholder="admin@akko.com" required>
                </div>
                <div>
                    <label class="font-bold text-sm">SENHA</label>
                    <input type="password" id="login-pass" class="w-full border-2 border-doodle-dark p-2" placeholder="********" required>
                </div>
                <button type="submit" id="btn-login" class="w-full bg-doodle-yellow font-comic text-2xl py-2 border-2 border-doodle-dark hover:bg-doodle-pink hover:text-white transition-colors">
                    ENTRAR NO PAINEL
                </button>
            </form>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="admin-panel" class="hidden flex w-full h-full">
        <!-- SIDEBAR -->
        <aside class="w-64 bg-white border-r-4 border-doodle-dark flex flex-col z-20 shadow-hard">
            <div class="h-20 flex items-center justify-center border-b-4 border-doodle-dark bg-doodle-yellow">
                <span class="font-comic text-3xl tracking-wide">AKKO <span class="text-white text-stroke-dark" style="-webkit-text-stroke: 1px black;">ADMIN</span></span>
            </div>

            <nav class="flex-1 p-4 space-y-2">
                <button id="nav-dashboard" onclick="switchTab('dashboard')" class="w-full text-left p-3 font-comic text-xl border-2 border-transparent rounded transition-all bg-doodle-pink text-white scale-105 shadow-sm flex items-center gap-3">
                    <i data-lucide="layout-dashboard" class="w-6 h-6"></i> DASHBOARD
                </button>
                <button id="nav-lessons" onclick="switchTab('lessons')" class="w-full text-left p-3 font-comic text-xl border-2 border-transparent rounded transition-all hover:bg-gray-100 flex items-center gap-3">
                    <i data-lucide="video" class="w-6 h-6"></i> AULAS
                </button>
                <button id="nav-students" onclick="switchTab('students')" class="w-full text-left p-3 font-comic text-xl border-2 border-transparent rounded transition-all hover:bg-gray-100 flex items-center gap-3">
                    <i data-lucide="users" class="w-6 h-6"></i> ALUNOS
                </button>
                <button id="nav-tests" onclick="switchTab('tests')" class="w-full text-left p-3 font-comic text-xl border-2 border-transparent rounded transition-all hover:bg-gray-100 flex items-center gap-3 text-gray-500">
                    <i data-lucide="flask-conical" class="w-6 h-6"></i> LAB DE TESTES
                </button>
            </nav>

            <div class="p-4 border-t-4 border-doodle-dark bg-gray-50">
                <div class="text-xs text-gray-400 mb-2 truncate" id="admin-email-display"></div>
                <button onclick="handleLogout()" class="flex items-center gap-2 text-sm font-bold text-red-500 hover:underline w-full">
                    <i data-lucide="log-out" class="w-4 h-4"></i> SAIR
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 overflow-y-auto relative bg-[url('https://www.transparenttextures.com/patterns/graphy.png')]">
            
            <header class="h-20 flex items-center px-8 justify-between">
                <h2 class="font-marker text-3xl text-doodle-dark/50">Painel de Controle</h2>
                <div class="bg-doodle-green px-3 py-1 rounded-full border-2 border-doodle-dark shadow-sm text-xs font-bold">ONLINE</div>
            </header>

            <div class="p-8 pt-0">
                
                <!-- VIEW: DASHBOARD -->
                <div id="view-dashboard" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 border-4 border-doodle-dark shadow-hard transform hover:-translate-y-1 transition-transform">
                            <div class="flex justify-between"><div><p class="font-comic text-xl text-gray-500">ALUNOS</p><h3 id="count-students" class="font-comic text-6xl text-doodle-purple">0</h3></div><div class="p-3 bg-doodle-purple text-white rounded-full border-2 border-doodle-dark h-fit"><i data-lucide="users"></i></div></div>
                        </div>
                        <div class="bg-white p-6 border-4 border-doodle-dark shadow-hard transform hover:-translate-y-1 transition-transform">
                            <div class="flex justify-between"><div><p class="font-comic text-xl text-gray-500">AULAS</p><h3 id="count-lessons" class="font-comic text-6xl text-doodle-pink">0</h3></div><div class="p-3 bg-doodle-pink text-white rounded-full border-2 border-doodle-dark h-fit"><i data-lucide="play-circle"></i></div></div>
                        </div>
                        <div class="bg-white p-6 border-4 border-doodle-dark shadow-hard transform hover:-translate-y-1 transition-transform">
                            <div class="flex justify-between"><div><p class="font-comic text-xl text-gray-500">MÓDULOS</p><h3 id="count-modules" class="font-comic text-6xl text-doodle-yellow">0</h3></div><div class="p-3 bg-doodle-yellow text-doodle-dark rounded-full border-2 border-doodle-dark h-fit"><i data-lucide="layers"></i></div></div>
                        </div>
                    </div>
                    <div class="bg-doodle-paper border-4 border-doodle-dark p-6 shadow-hard-sm flex gap-4">
                        <button onclick="switchTab('lessons'); openCreateLesson()" class="px-6 py-3 bg-doodle-green border-2 border-doodle-dark font-comic text-xl shadow-sm hover:scale-105 transition-transform">+ NOVA AULA</button>
                        <a href="membros.html" target="_blank" class="px-6 py-3 bg-white border-2 border-doodle-dark font-comic text-xl shadow-sm hover:scale-105 transition-transform text-doodle-dark">VER SITE</a>
                    </div>
                </div>

                <!-- VIEW: LESSONS -->
                <div id="view-lessons" class="hidden flex-col h-full">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="font-comic text-4xl text-doodle-dark">GERENCIAR AULAS</h1>
                        <button onclick="openCreateLesson()" class="bg-doodle-green text-doodle-dark px-6 py-2 font-comic text-xl border-2 border-doodle-dark shadow-hard hover:bg-white">+ NOVA AULA</button>
                    </div>
                    <div class="bg-white border-4 border-doodle-dark shadow-hard flex-1 flex flex-col min-h-[500px]">
                        <div class="p-4 border-b-2 border-doodle-dark bg-gray-50 flex gap-4">
                            <div class="relative flex-1"><i data-lucide="search" class="absolute left-3 top-3 w-5 h-5 text-gray-400"></i><input type="text" onkeyup="filterLessons(event)" placeholder="Buscar..." class="w-full pl-10 pr-4 py-2 border-2 border-doodle-dark rounded"></div>
                        </div>
                        <div class="grid grid-cols-[1fr_2fr_1fr_100px_100px] bg-doodle-yellow border-b-2 border-doodle-dark font-comic text-lg p-2 px-4">
                            <div>MÓDULO</div><div>TÍTULO</div><div>PROF.</div><div class="text-center">ANEXO</div><div class="text-right">AÇÕES</div>
                        </div>
                        <div class="overflow-y-auto flex-1 custom-scroll"><table class="w-full text-left border-collapse"><tbody id="lessons-table-body"></tbody></table></div>
                    </div>
                </div>

                <!-- VIEW: STUDENTS -->
                <div id="view-students" class="hidden flex-col h-full">
                    <div class="grid md:grid-cols-3 gap-6 h-full">
                        <!-- Novo Aluno (Bloqueado - Use o Lab) -->
                        <div class="col-span-1 bg-white border-4 border-doodle-dark shadow-hard p-6 h-fit opacity-70">
                            <div class="flex items-center gap-2 mb-4 border-b-2 border-dashed border-gray-300 pb-2">
                                <i data-lucide="user-plus" class="w-6 h-6 text-doodle-purple"></i>
                                <h2 class="font-comic text-2xl">NOVO ALUNO</h2>
                            </div>
                            <div class="text-center text-sm font-bold text-gray-500 py-10">
                                Para criar alunos, use o<br>
                                <button onclick="switchTab('tests')" class="text-blue-600 underline">LAB DE TESTES</button>
                            </div>
                        </div>

                        <!-- Lista -->
                        <div class="col-span-2 bg-white border-4 border-doodle-dark shadow-hard flex flex-col min-h-[500px]">
                            <div class="p-4 border-b-2 border-doodle-dark bg-gray-50 flex justify-between items-center">
                                <h3 class="font-comic text-xl">BASE DE ALUNOS</h3>
                                <div class="flex gap-2">
                                    <!-- NOVO BOTÃO DE SYNC -->
                                    <button onclick="syncUsers()" id="btn-sync" class="bg-doodle-yellow px-3 py-1 font-bold text-xs border-2 border-doodle-dark flex items-center shadow-sm hover:translate-y-1 transition-transform">
                                        <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i> SINCRONIZAR AUTH
                                    </button>
                                    <div class="relative w-48"><i data-lucide="search" class="absolute left-2 top-2 w-4 h-4 text-gray-400"></i><input type="text" onkeyup="filterStudents(event)" placeholder="Buscar aluno..." class="w-full pl-8 py-1 border-2 border-doodle-dark text-sm rounded"></div>
                                </div>
                            </div>
                            <div class="overflow-y-auto flex-1 custom-scroll p-0"><table class="w-full text-left"><thead class="bg-gray-100 border-b border-gray-200 text-xs font-bold text-gray-500"><tr><th class="p-3">NOME</th><th class="p-3">EMAIL</th><th class="p-3">DATA</th><th class="p-3 text-right">AÇÃO</th></tr></thead><tbody id="students-table-body"></tbody></table></div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: TESTS (LAB) -->
                <div id="view-tests" class="hidden flex-col h-full space-y-6">
                    <h1 class="font-comic text-4xl text-doodle-dark mb-4">LABORATÓRIO DE TESTES</h1>
                    <div class="grid grid-cols-2 gap-6">
                        <!-- TESTE 1: WEBHOOK -->
                        <div class="bg-white border-4 border-doodle-dark shadow-hard p-6">
                            <h3 class="font-marker text-xl mb-2 text-doodle-green">1. Testar Webhook (Email)</h3>
                            <p class="text-xs text-gray-500 mb-4">Simula uma venda da Hotmart/Cakto.</p>
                            <input type="url" id="webhook-url" class="w-full border-2 border-doodle-dark p-2 text-sm mb-2" placeholder="Cole a URL da Cloud Function aqui">
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="webhook-name" value="Teste Webhook" class="w-1/2 border-2 border-doodle-dark p-2 text-sm">
                                <input type="email" id="webhook-email" value="teste@webhook.com" class="w-1/2 border-2 border-doodle-dark p-2 text-sm">
                            </div>
                            <button onclick="testWebhook(event)" id="btn-webhook" class="w-full bg-doodle-green border-2 border-doodle-dark font-bold py-2 shadow-sm hover:translate-y-1 transition-transform">DISPARAR TESTE</button>
                            <div id="log-webhook" class="mt-2 text-xs h-20 overflow-y-auto bg-gray-100 p-2 border border-doodle-dark/20 text-gray-600 font-mono">Logs aparecerão aqui...</div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL DE EDIÇÃO DE AULA -->
    <div id="lesson-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg border-4 border-doodle-dark shadow-hard p-6 relative transform rotate-1">
            <button onclick="closeLessonModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-500 font-bold text-xl">X</button>
            <h2 id="lesson-modal-title" class="font-comic text-3xl text-doodle-dark mb-4 border-b-2 border-doodle-dark pb-2">NOVA AULA</h2>
            <form id="lesson-form" onsubmit="handleSaveLesson(event)" class="space-y-3">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="font-bold text-xs">MÓDULO</label><input list="existing-modules" type="text" id="inp-module" class="w-full border-2 border-doodle-dark p-2 text-sm" required><datalist id="existing-modules"></datalist></div>
                    <div><label class="font-bold text-xs">PROFESSOR</label><input type="text" id="inp-prof" class="w-full border-2 border-doodle-dark p-2 text-sm" required></div>
                </div>
                <div><label class="font-bold text-xs">TÍTULO DA AULA</label><input type="text" id="inp-title" class="w-full border-2 border-doodle-dark p-2 text-sm" required></div>
                <div>
                    <label class="font-bold text-xs block mb-1">VÍDEO (LINK OU UPLOAD)</label>
                    <div class="flex gap-2 mb-2"><button type="button" id="tab-url" onclick="toggleVideoInput('url')" class="px-3 py-1 text-xs font-bold border-2 border-doodle-dark bg-doodle-yellow">LINK</button><button type="button" id="tab-file" onclick="toggleVideoInput('file')" class="px-3 py-1 text-xs font-bold border-2 border-doodle-dark bg-white">ARQUIVO</button></div>
                    <div id="container-url"><input type="text" id="inp-url" class="w-full border-2 border-doodle-dark p-2 text-sm" placeholder="https://youtube.com/..."></div>
                    <div id="container-file" class="hidden"><input type="file" id="inp-file" class="w-full text-sm" accept="video/*"></div>
                </div>
                <div>
                    <label class="font-bold text-xs block mb-1">MATERIAL DE APOIO</label>
                    <div class="border-2 border-doodle-dark p-2 bg-gray-50 flex items-center justify-between"><input type="file" id="inp-attachment" class="w-full text-sm"><div id="current-attachment" class="hidden text-xs text-blue-600 font-bold ml-2"><a href="#" target="_blank" id="attachment-link">Ver Atual</a></div></div>
                </div>
                <div><label class="font-bold text-xs">DESCRIÇÃO</label><textarea id="inp-desc" class="w-full border-2 border-doodle-dark p-2 text-sm h-24"></textarea></div>
                <div class="pt-2"><button type="submit" id="btn-save-lesson" class="w-full bg-doodle-green py-3 font-comic text-xl border-2 border-doodle-dark shadow-sm hover:translate-y-1 transition-transform">SALVAR DADOS</button></div>
            </form>
        </div>
    </div>

    <script>lucide.createIcons();</script>
</body>
</html>